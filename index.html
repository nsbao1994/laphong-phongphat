<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qu·∫£n l√Ω Kho La Ph√¥ng - PHONG PH√ÅT</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f4f6f9;min-height:100vh;padding:8px;font-size:14px}
  .container{max-width:1200px;margin:auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1)}
  .header{background:linear-gradient(45deg,#2196F3,#21CBF3);color:#fff;padding:16px;text-align:center}
  .header h1{font-size:1.4rem;margin-bottom:8px}
  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:12px}
  .stat-item{text-align:center;background:rgba(255,255,255,0.1);padding:8px;border-radius:8px}
  .stat-item h3{font-size:1.1rem;margin-bottom:2px}
  .stat-item p{font-size:0.85rem;opacity:0.9}
  
  .tab-container{display:flex;background:#f8f9fa;border-bottom:1px solid #ddd;overflow-x:auto}
  .tab{padding:12px 16px;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.3s;white-space:nowrap;font-weight:500}
  .tab.active{background:#fff;border-bottom-color:#2196F3;color:#2196F3}
  .tab:hover{background:#e9ecef}
  
  .tab-content{display:none;padding:16px}
  .tab-content.active{display:block}
  
  label{display:block;margin-bottom:4px;font-weight:600;color:#333}
  input,select,textarea{width:100%;padding:12px;margin-bottom:10px;border:1px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.3s}
  input:focus,select:focus,textarea:focus{outline:none;border-color:#2196F3;box-shadow:0 0 0 2px rgba(33,150,243,0.1)}
  
  .btn{padding:10px 16px;border-radius:8px;border:0;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;display:inline-flex;align-items:center;gap:6px}
  .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .btn-primary{background:#2196F3;color:#fff}
  .btn-success{background:#4CAF50;color:#fff}
  .btn-warning{background:#ff9800;color:#fff}
  .btn-danger{background:#f44336;color:#fff}
  .btn-small{padding:6px 10px;font-size:12px}
  
  .search-bar{padding:12px 16px;border-radius:25px;border:1px solid #ddd;margin-bottom:16px;width:100%;font-size:14px}
  .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .product-card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);border-left:5px solid #2196F3;transition:transform 0.3s}
  .product-card:hover{transform:translateY(-2px)}
  .product-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  
  .alert{padding:12px;border-radius:8px;margin-bottom:16px;font-weight:500}
  .alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
  .alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  
  .data-table{width:100%;border-collapse:collapse;margin-top:16px;background:#fff;border-radius:8px;overflow:hidden;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
  .data-table th,.data-table td{padding:10px 8px;border-bottom:1px solid #eee;text-align:left}
  .data-table th{background:#f8f9fa;font-weight:600;color:#495057}
  .data-table tr:hover{background:#f8f9fa}
  .low{color:#dc3545;font-weight:bold}
  
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:none}
  .modal-content{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:24px;border-radius:12px;width:90%;max-width:450px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid #eee;padding-bottom:12px}
  .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#999;padding:4px}
  .modal-footer{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
  
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form-group{background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px}
  
  .empty-state{text-align:center;padding:40px 20px;color:#6c757d}
  .empty-state svg{width:48px;height:48px;margin-bottom:16px;opacity:0.5}
  
  @media(max-width:768px){
    body{padding:4px;font-size:13px}
    .container{border-radius:8px}
    .header{padding:12px}
    .header h1{font-size:1.2rem}
    .stats{grid-template-columns:repeat(3,1fr);gap:6px}
    .stat-item{padding:6px}
    .stat-item h3{font-size:1rem}
    .tab-content{padding:12px}
    .product-grid{grid-template-columns:1fr;gap:12px}
    .product-card{padding:12px}
    .modal-content{padding:16px;border-radius:8px}
    .modal-footer{justify-content:stretch}
    .modal-footer .btn{flex:1}
    .data-table{display:block;overflow-x:auto;white-space:nowrap}
    .data-table th,.data-table td{padding:8px 6px;font-size:12px}
    .form-row{grid-template-columns:1fr}
    .product-actions{flex-direction:column}
    .product-actions .btn{justify-content:center}
  }
  
  .delete-btn{background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px}
  .delete-btn:hover{background:#c82333}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üè™ Qu·∫£n l√Ω Kho La Ph√¥ng - PHONG PH√ÅT</h1>
    <div id="connectionStatus" style="margin-top:5px;font-size:0.9rem">üîÑ ƒêang k·∫øt n·ªëi Firestore...</div>
    <div class="stats">
      <div class="stat-item"><h3 id="totalProducts">0</h3><p>T·ªïng s·∫£n ph·∫©m</p></div>
      <div class="stat-item"><h3 id="totalValue">0‚Ç´</h3><p>T·ªïng gi√° tr·ªã</p></div>
      <div class="stat-item"><h3 id="lowStock">0</h3><p>S·∫Øp h·∫øt h√†ng</p></div>
    </div>
  </div>
  
  <div class="tab-container">
    <div class="tab active" onclick="warehouse.switchTab('overview')">üìä T·ªïng qu√°t</div>
    <div class="tab" onclick="warehouse.switchTab('products')">üì¶ S·∫£n ph·∫©m</div>
    <div class="tab" onclick="warehouse.switchTab('sales')">üí∞ L·ªãch s·ª≠ b√°n</div>
    <div class="tab" onclick="warehouse.switchTab('imports')">üì• L·ªãch s·ª≠ nh·∫≠p</div>
  </div>

  <!-- Tab T·ªïng qu√°t -->
  <div id="overview" class="tab-content active">
    <h3 style="margin-bottom:16px">üìä T·ªïng quan kho h√†ng</h3>
    <div class="product-grid" id="overviewGrid"></div>
  </div>

  <!-- Tab S·∫£n ph·∫©m -->
  <div id="products" class="tab-content">
    <div style="display:grid;grid-template-columns:1fr 2fr;gap:20px">
      <div>
        <h3 style="margin-bottom:12px">üì¶ Nh·∫≠p / C·∫≠p nh·∫≠t h√†ng</h3>
        <form id="productForm">
          <label>T√™n s·∫£n ph·∫©m</label><input id="productName" required>
          <label>M√£ s·∫£n ph·∫©m</label><input id="productCode" required>
          <label>Danh m·ª•c</label>
          <select id="productCategory" required>
            <option value="">Ch·ªçn danh m·ª•c</option>
            <option>La Ph√¥ng Th∆∞·ªùng</option>
            <option>La Ph√¥ng √Ånh Kim</option>
            <option>Khung X∆∞∆°ng Tr·∫ßn Th·∫£</option>
            <option>Khung X∆∞∆°ng Th·∫°ch Cao</option>
            <option>Th·∫°ch Cao</option>
            <option>T·∫•m Nh·ª±a</option>
            <option>Kh√°c</option>
          </select>
          <div class="form-row">
            <div>
              <label>Gi√° (VNƒê)</label>
              <input id="productPrice" type="number" min="0" required>
            </div>
            <div>
              <label>S·ªë l∆∞·ª£ng nh·∫≠p m·ªõi</label>
              <input id="productNewStock" type="number" min="0" value="0">
            </div>
          </div>
          <label>Ng√†y nh·∫≠p h√†ng</label><input id="productImportDate" type="date">
          <label>M√¥ t·∫£</label><textarea id="productDescription" rows="2"></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-success" id="submitBtn" type="submit">üì¶ Nh·∫≠p h√†ng</button>
            <button class="btn btn-warning" id="cancelBtn" type="button" style="display:none">H·ªßy</button>
          </div>
        </form>
      </div>
      <div>
        <input id="searchInput" class="search-bar" placeholder="üîç T√¨m ki·∫øm theo t√™n ho·∫∑c m√£">
        <div id="alertContainer"></div>
        <div class="product-grid" id="productGrid"></div>
      </div>
    </div>
  </div>

  <!-- Tab L·ªãch s·ª≠ b√°n h√†ng -->
  <div id="sales" class="tab-content">
    <h3 style="margin-bottom:16px">üí∞ L·ªãch s·ª≠ b√°n h√†ng</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Ng√†y</th>
          <th>S·∫£n ph·∫©m</th>
          <th>M√£</th>
          <th>SL</th>
          <th>Gi√°</th>
          <th>Th√†nh ti·ªÅn</th>
          <th>Ghi ch√∫</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="salesHistory">
        <tr><td colspan="8" class="empty-state">Ch∆∞a c√≥ giao d·ªãch</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Tab L·ªãch s·ª≠ nh·∫≠p h√†ng -->
  <div id="imports" class="tab-content">
    <h3 style="margin-bottom:16px">üì• L·ªãch s·ª≠ nh·∫≠p h√†ng</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Ng√†y nh·∫≠p</th>
          <th>S·∫£n ph·∫©m</th>
          <th>M√£</th>
          <th>SL nh·∫≠p</th>
          <th>Gi√°</th>
          <th>Th√†nh ti·ªÅn</th>
          <th>Ghi ch√∫</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="importHistory">
        <tr><td colspan="8" class="empty-state">Ch∆∞a c√≥ nh·∫≠p h√†ng</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal B√°n H√†ng -->
<div id="saleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üí∞ B√°n H√†ng</h3>
      <button class="modal-close" onclick="warehouse.closeSaleModal()">&times;</button>
    </div>
    <form id="saleForm">
      <div id="saleProductInfo" class="form-group"></div>
      <div class="form-row">
        <div>
          <label>S·ªë l∆∞·ª£ng b√°n</label>
          <input id="saleQuantity" type="number" min="1" required>
        </div>
        <div>
          <label>Gi√° b√°n (VNƒê)</label>
          <input id="salePrice" type="number" min="0" required>
        </div>
      </div>
      <div class="form-group" style="background:#e3f2fd">
        <strong>üí∞ Th√†nh ti·ªÅn: <span id="saleTotal">0‚Ç´</span></strong>
      </div>
      <label>Ng√†y b√°n</label>
      <input id="saleDate" type="date" required>
      <label>Ghi ch√∫</label>
      <textarea id="saleNote" rows="2" placeholder="Kh√°ch h√†ng, ghi ch√∫..."></textarea>
      <div class="modal-footer">
        <button class="btn btn-success" type="submit">üí∞ X√°c nh·∫≠n b√°n</button>
        <button class="btn" type="button" onclick="warehouse.closeSaleModal()">H·ªßy</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB06U8J2owwj03mOU2MdcGlMnNxA0NN3Ms",
  authDomain: "la-phon-phong-phat.firebaseapp.com",
  projectId: "la-phon-phong-phat",
  storageBucket: "la-phon-phong-phat.firebasestorage.app",
  messagingSenderId: "643189174098",
  appId: "1:643189174098:web:ed119570c5cb2e36e8148b",
  measurementId: "G-BCK9B2Z2J6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Kh·ªüi t·∫°o collection n·∫øu ch∆∞a c√≥
async function initCollections() {
  for (let col of ["products","sales","imports"]) {
    const snap = await getDocs(collection(db,col));
    if (snap.empty) {
      await addDoc(collection(db,col), { init: true, createdAt: new Date().toISOString() });
    }
  }
}

await initCollections();
document.getElementById('connectionStatus').textContent = '‚úÖ K·∫øt n·ªëi Firestore th√†nh c√¥ng';

class WarehouseManager {
  constructor(){
    this.products = {};
    this.sales = [];
    this.imports = [];
    this.editingId = null;
    this.saleProductId = null;
    this.currentTab = 'overview';
    this.initEvents();
    this.listenData();
  }

  // Format ti·ªÅn t·ªá VNƒê
  formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount) + '‚Ç´';
  }

  // Chuy·ªÉn ƒë·ªïi tab
  switchTab(tabName) {
    // ·∫®n t·∫•t c·∫£ tab content
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
    this.currentTab = tabName;
  }

  initEvents(){
    document.getElementById('productForm').addEventListener('submit', e=>this.saveProduct(e));
    document.getElementById('cancelBtn').addEventListener('click', ()=>this.cancelEdit());
    document.getElementById('searchInput').addEventListener('input', e=>this.renderProducts(e.target.value));
    document.getElementById('saleForm').addEventListener('submit', e=>this.confirmSale(e));
    
    // T√≠nh th√†nh ti·ªÅn khi thay ƒë·ªïi s·ªë l∆∞·ª£ng ho·∫∑c gi√°
    document.getElementById('saleQuantity').addEventListener('input', ()=>this.calculateSaleTotal());
    document.getElementById('salePrice').addEventListener('input', ()=>this.calculateSaleTotal());
  }

  listenData(){
    onSnapshot(collection(db,'products'), snap=>{
      this.products = {};
      snap.forEach(docSnap => { 
        if(!docSnap.data().init) {
          this.products[docSnap.id] = {id:docSnap.id, ...docSnap.data()}; 
        }
      });
      this.renderProducts();
      this.renderOverview();
      this.updateStats();
    });

    onSnapshot(query(collection(db,'sales'), orderBy('date','desc')), snap=>{
      this.sales = [];
      snap.forEach(docSnap => { 
        if(!docSnap.data().init) {
          this.sales.push({id: docSnap.id, ...docSnap.data()});
        }
      });
      this.renderHistory(this.sales,'salesHistory', 'sales');
    });

    onSnapshot(query(collection(db,'imports'), orderBy('date','desc')), snap=>{
      this.imports = [];
      snap.forEach(docSnap => { 
        if(!docSnap.data().init) {
          this.imports.push({id: docSnap.id, ...docSnap.data()});
        }
      });
      this.renderHistory(this.imports,'importHistory', 'imports');
    });
  }

  async saveProduct(e){
    e.preventDefault();
    const name = document.getElementById('productName').value.trim();
    const code = document.getElementById('productCode').value.trim();
    const category = document.getElementById('productCategory').value;
    const price = Number(document.getElementById('productPrice').value)||0;
    const addStock = Number(document.getElementById('productNewStock').value)||0;
    const importDate = document.getElementById('productImportDate').value || new Date().toISOString().split('T')[0];
    const desc = document.getElementById('productDescription').value.trim();

    if(this.editingId){
      let p = this.products[this.editingId];
      const newStock = (p.stock||0) + addStock;
      await updateDoc(doc(db,'products',this.editingId), {
        name, code, category, price, stock:newStock, description:desc, updatedAt: new Date().toISOString()
      });
      if(addStock>0){
        await addDoc(collection(db,'imports'), { 
          productId: this.editingId,
          name, code, qty:addStock, price, total:addStock*price, date:importDate, note:"Nh·∫≠p th√™m", createdAt:new Date().toISOString() 
        });
      }
      this.showAlert('‚úÖ C·∫≠p nh·∫≠t h√†ng th√†nh c√¥ng','success');
    } else {
      const docRef = await addDoc(collection(db,'products'), {
        name, code, category, price, stock:addStock, sold:0, description:desc, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
      });
      if(addStock>0){
        await addDoc(collection(db,'imports'), { 
          productId: docRef.id,
          name, code, qty:addStock, price, total:addStock*price, date:importDate, note:"Nh·∫≠p m·ªõi", createdAt:new Date().toISOString() 
        });
      }
      this.showAlert('‚úÖ Nh·∫≠p h√†ng th√†nh c√¥ng','success');
    }
    this.clearForm(); this.cancelEdit();
  }

  editProduct(id){
    const p = this.products[id];
    this.editingId = id;
    document.getElementById('productName').value = p.name;
    document.getElementById('productCode').value = p.code;
    document.getElementById('productCategory').value = p.category;
    document.getElementById('productPrice').value = p.price;
    document.getElementById('productNewStock').value = 0;
    document.getElementById('productImportDate').value = '';
    document.getElementById('productDescription').value = p.description || '';
    document.getElementById('submitBtn').textContent = '‚úèÔ∏è C·∫≠p nh·∫≠t h√†ng';
    document.getElementById('submitBtn').className = 'btn btn-warning';
    document.getElementById('cancelBtn').style.display = 'inline-block';
    
    // Chuy·ªÉn sang tab s·∫£n ph·∫©m
    this.switchTab('products');
  }

  cancelEdit(){
    this.editingId = null;
    document.getElementById('submitBtn').textContent = 'üì¶ Nh·∫≠p h√†ng';
    document.getElementById('submitBtn').className = 'btn btn-success';
    document.getElementById('cancelBtn').style.display = 'none';
    this.clearForm();
  }

  async deleteProduct(id){
    if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y? T·∫•t c·∫£ l·ªãch s·ª≠ b√°n h√†ng v√† nh·∫≠p h√†ng li√™n quan c≈©ng s·∫Ω b·ªã x√≥a.')) return;
    
    // X√≥a s·∫£n ph·∫©m
    await deleteDoc(doc(db,'products',id));
    
    // X√≥a l·ªãch s·ª≠ b√°n h√†ng li√™n quan
    const salesQuery = query(collection(db, 'sales'), where('productId', '==', id));
    const salesSnap = await getDocs(salesQuery);
    salesSnap.forEach(async (docSnap) => {
      await deleteDoc(doc(db, 'sales', docSnap.id));
    });
    
    // X√≥a l·ªãch s·ª≠ nh·∫≠p h√†ng li√™n quan
    const importsQuery = query(collection(db, 'imports'), where('productId', '==', id));
    const importsSnap = await getDocs(importsQuery);
    importsSnap.forEach(async (docSnap) => {
      await deleteDoc(doc(db, 'imports', docSnap.id));
    });
    
    this.showAlert('‚úÖ X√≥a s·∫£n ph·∫©m v√† l·ªãch s·ª≠ li√™n quan','success');
  }

  async deleteSale(id) {
    if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a giao d·ªãch n√†y?')) return;
    await deleteDoc(doc(db,'sales',id));
    this.showAlert('‚úÖ X√≥a giao d·ªãch th√†nh c√¥ng','success');
  }

  async deleteImport(id) {
    if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£n ghi nh·∫≠p h√†ng n√†y?')) return;
    await deleteDoc(doc(db,'imports',id));
    this.showAlert('‚úÖ X√≥a b·∫£n ghi nh·∫≠p h√†ng th√†nh c√¥ng','success');
  }

  openSaleModal(id){
    const p = this.products[id];
    if((p.stock||0) <= 0){ this.showAlert('‚ö† S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng','error'); return; }
    this.saleProductId = id;
    document.getElementById('saleProductInfo').innerHTML = `
      <h4>${p.name}</h4>
      <div><strong>M√£:</strong> ${p.code} | <strong>T·ªìn:</strong> ${p.stock} | <strong>Gi√°:</strong> ${this.formatCurrency(p.price)}</div>
    `;
    document.getElementById('saleQuantity').max = p.stock;
    document.getElementById('saleQuantity').value = 1;
    document.getElementById('salePrice').value = p.price;
    document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('saleNote').value = '';
    this.calculateSaleTotal();
    document.getElementById('saleModal').style.display = 'block';
  }

  calculateSaleTotal(){
    const qty = Number(document.getElementById('saleQuantity').value) || 0;
    const price = Number(document.getElementById('salePrice').value) || 0;
    const total = qty * price;
    document.getElementById('saleTotal').textContent = this.formatCurrency(total);
  }

  closeSaleModal(){
    document.getElementById('saleModal').style.display = 'none';
    this.saleProductId = null;
    document.getElementById('saleForm').reset();
  }

  async confirmSale(e){
    e.preventDefault();
    if(!this.saleProductId) return;
    const p = this.products[this.saleProductId];
    const qty = Number(document.getElementById('saleQuantity').value)||0;
    const price = Number(document.getElementById('salePrice').value)||0;
    const date = document.getElementById('saleDate').value;
    const note = document.getElementById('saleNote').value.trim();

    if(qty > (p.stock||0)){ this.showAlert('‚ö† S·ªë l∆∞·ª£ng b√°n v∆∞·ª£t qu√° t·ªìn kho','error'); return; }
    if(qty <= 0){ this.showAlert('‚ö† S·ªë l∆∞·ª£ng b√°n ph·∫£i l·ªõn h∆°n 0','error'); return; }

    const newStock = (p.stock||0) - qty;
    const newSold = (p.sold||0) + qty;
    
    await updateDoc(doc(db,'products',this.saleProductId), {
      stock: newStock, sold: newSold, updatedAt: new Date().toISOString()
    });
    
    await addDoc(collection(db,'sales'), {
      productId: this.saleProductId,
      name: p.name, code: p.code, qty, price, total: qty*price, date, note,
      createdAt: new Date().toISOString()
    });

    this.showAlert(`‚úÖ ƒê√£ b√°n ${qty} ${p.name}`, 'success');
    this.closeSaleModal();
  }

  renderOverview() {
    const grid = document.getElementById('overviewGrid');
    let arr = Object.values(this.products);
    if(arr.length===0){ 
      grid.innerHTML = '<div class="empty-state"><p>Kh√¥ng c√≥ s·∫£n ph·∫©m</p></div>'; 
      return; 
    }
    
    // S·∫Øp x·∫øp theo t·ªìn kho th·∫•p tr∆∞·ªõc
    arr.sort((a,b) => (a.stock||0) - (b.stock||0));
    
    grid.innerHTML = arr.map(p=>{
      const low = (p.stock||0)<=10;
      return `<div class="product-card">
        <h3>${p.name}</h3>
        <div><strong>M√£:</strong> ${p.code}</div>
        <div><strong>Danh m·ª•c:</strong> ${p.category}</div>
        <div><strong>Gi√°:</strong> ${this.formatCurrency(p.price)}</div>
        <div><strong>T·ªìn kho:</strong> ${p.stock} ${low?'<span class="low">üî¥ S·∫Øp h·∫øt</span>':''}</div>
        <div><strong>ƒê√£ b√°n:</strong> ${p.sold||0}</div>
        ${p.description?`<div><strong>M√¥ t·∫£:</strong> ${p.description}</div>`:''}
        <div class="product-actions">
          <button class="btn btn-primary btn-small" onclick="warehouse.openSaleModal('${p.id}')">üí∞ B√°n</button>
          <button class="btn btn-warning btn-small" onclick="warehouse.editProduct('${p.id}')">‚úèÔ∏è S·ª≠a</button>
        </div>
      </div>`;
    }).join('');
  }

  renderProducts(search=''){
    const grid = document.getElementById('productGrid');
    let arr = Object.values(this.products);
    if(search){
      search = search.toLowerCase();
      arr = arr.filter(p=> 
        p.name.toLowerCase().includes(search) || 
        p.code.toLowerCase().includes(search) ||
        p.category.toLowerCase().includes(search)
      );
    }
    if(arr.length===0){ 
      grid.innerHTML = '<div class="empty-state"><p>Kh√¥ng c√≥ s·∫£n ph·∫©m</p></div>'; 
      return; 
    }
    
    grid.innerHTML = arr.map(p=>{
      const low = (p.stock||0)<=10;
      return `<div class="product-card">
        <h3>${p.name}</h3>
        <div><strong>M√£:</strong> ${p.code}</div>
        <div><strong>Danh m·ª•c:</strong> ${p.category}</div>
        <div><strong>Gi√°:</strong> ${this.formatCurrency(p.price)}</div>
        <div><strong>T·ªìn kho:</strong> ${p.stock} ${low?'<span class="low">üî¥ S·∫Øp h·∫øt</span>':''}</div>
        <div><strong>ƒê√£ b√°n:</strong> ${p.sold||0}</div>
        ${p.description?`<div><strong>M√¥ t·∫£:</strong> ${p.description}</div>`:''}
        <div class="product-actions">
          <button class="btn btn-primary" onclick="warehouse.openSaleModal('${p.id}')">üí∞ B√°n h√†ng</button>
          <button class="btn btn-warning" onclick="warehouse.editProduct('${p.id}')">‚úèÔ∏è C·∫≠p nh·∫≠t</button>
          <button class="btn btn-danger" onclick="warehouse.deleteProduct('${p.id}')">üóëÔ∏è X√≥a</button>
        </div>
      </div>`;
    }).join('');
  }

  renderHistory(arr, elId, type){
    const tbody = document.getElementById(elId);
    if(arr.length===0){ 
      tbody.innerHTML = `<tr><td colspan="8" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`; 
      return; 
    }
    
    tbody.innerHTML = arr.map(s=>`
      <tr>
        <td>${s.date||''}</td>
        <td>${s.name||''}</td>
        <td>${s.code||''}</td>
        <td>${s.qty||0}</td>
        <td>${this.formatCurrency(s.price||0)}</td>
        <td><strong>${this.formatCurrency(s.total||0)}</strong></td>
        <td>${s.note||''}</td>
        <td>
          <button class="delete-btn" onclick="warehouse.${type==='sales'?'deleteSale':'deleteImport'}('${s.id}')">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
  }

  updateStats(){
    let arr = Object.values(this.products);
    document.getElementById('totalProducts').textContent = arr.length;
    document.getElementById('totalValue').textContent = this.formatCurrency(arr.reduce((a,p)=>a+(p.price||0)*(p.stock||0),0));
    document.getElementById('lowStock').textContent = arr.filter(p=>(p.stock||0)<=10).length;
  }

  clearForm(){ 
    document.getElementById('productForm').reset(); 
    document.getElementById('productImportDate').value = new Date().toISOString().split('T')[0];
  }
  
  showAlert(msg,type){ 
    const c=document.getElementById('alertContainer'); 
    c.innerHTML=`<div class="alert ${type==='success'?'alert-success':'alert-error'}">${msg}</div>`; 
    setTimeout(()=>c.innerHTML='',4000);
  }
}

const warehouse = new WarehouseManager();
window.warehouse = warehouse;

// ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh khi t·∫£i trang
document.getElementById('productImportDate').value = new Date().toISOString().split('T')[0];
</script>
</body>
</html>
