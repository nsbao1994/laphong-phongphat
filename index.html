<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý kho La Phông - PHONG PHÁT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f8f9fa; }
    .tabs { position: fixed; bottom:0; left:0; right:0; display:flex; background:#fff; border-top:1px solid #ccc; }
    .tab { flex:1; text-align:center; padding:12px; cursor:pointer; font-size:15px; }
    .tab.active { background:#e9ecef; font-weight:bold; }
    .tab-content { display:none; padding:15px; margin-bottom:70px; }
    .product-card { border-radius:12px; padding:12px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .badge-cat { padding:5px 10px; border-radius:12px; font-size:13px; }
    .btn-sm { padding:6px 12px; font-size:14px; }
  </style>
</head>
<body>
  <!-- Đăng nhập -->
  <div id="loginScreen" class="d-flex justify-content-center align-items-center vh-100 bg-light">
    <div class="card p-4 shadow" style="width:350px;">
      <h4 class="text-center mb-3">Đăng nhập</h4>
      <input id="loginEmail" type="email" class="form-control mb-2" placeholder="Email">
      <input id="loginPass" type="password" class="form-control mb-2" placeholder="Mật khẩu">
      <button onclick="login()" class="btn btn-primary w-100 mb-2">Đăng nhập</button>
      <button onclick="register()" class="btn btn-secondary w-100">Đăng ký</button>
    </div>
  </div>

  <!-- App -->
  <div id="appContainer" style="display:none;">
    <div class="container-fluid">
      <button onclick="logout()" class="btn btn-danger position-absolute top-0 end-0 m-2">Đăng xuất</button>
      <div id="alertContainer"></div>

      <!-- Tổng quan -->
      <div id="overview" class="tab-content">
        <h4>Tổng quan</h4>
        <div class="row text-center">
          <div class="col-6 col-md-3"><div class="card p-3"><strong id="totalProducts">0</strong><div>Sản phẩm</div></div></div>
          <div class="col-6 col-md-3"><div class="card p-3"><strong id="totalValue">0₫</strong><div>Giá trị nhập</div></div></div>
          <div class="col-6 col-md-3"><div class="card p-3"><strong id="lowStock">0</strong><div>Sắp hết</div></div></div>
          <div class="col-6 col-md-3"><div class="card p-3"><strong id="totalSales">0₫</strong><div>Đã bán</div></div></div>
        </div>

        <h5 class="mt-3">Nhập hàng</h5>
        <form id="productForm" onsubmit="warehouse.saveProduct(event)" class="row g-2">
          <div class="col-6"><input id="productName" class="form-control" placeholder="Tên sản phẩm" required></div>
          <div class="col-6"><input id="productCode" class="form-control" placeholder="Mã sản phẩm" required></div>
          <div class="col-6"><select id="productCategory" class="form-control" required></select></div>
          <div class="col-6"><input id="productImportPrice" type="number" class="form-control" placeholder="Giá nhập" required></div>
          <div class="col-6"><input id="productSellPrice" type="number" class="form-control" placeholder="Giá bán" required></div>
          <div class="col-6"><input id="productStock" type="number" class="form-control" placeholder="Số lượng nhập" required></div>
          <div class="col-12"><textarea id="productDesc" class="form-control" placeholder="Mô tả"></textarea></div>
          <div class="col-12"><button type="submit" class="btn btn-success w-100">Lưu</button></div>
        </form>
      </div>

      <!-- Sản phẩm -->
      <div id="products" class="tab-content">
        <h4>Danh sách sản phẩm</h4>
        <div id="productList"></div>
      </div>

      <!-- Bán -->
      <div id="sales" class="tab-content">
        <h4>Lịch sử bán</h4>
        <table class="table table-sm table-bordered">
          <thead><tr><th>Ngày</th><th>Tên</th><th>SL</th><th>Tổng</th><th>Xóa</th></tr></thead>
          <tbody id="salesHistory"></tbody>
        </table>
      </div>

      <!-- Nhập -->
      <div id="imports" class="tab-content">
        <h4>Lịch sử nhập</h4>
        <table class="table table-sm table-bordered">
          <thead><tr><th>Ngày</th><th>Tên</th><th>SL</th><th>Tổng</th><th>Xóa</th></tr></thead>
          <tbody id="importHistory"></tbody>
        </table>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
     <div class="tab" onclick="openTab('overview',this)">Tổng quan</div>
<div class="tab" onclick="openTab('products',this)">Sản phẩm</div>
<div class="tab" onclick="openTab('sales',this)">Bán</div>
<div class="tab" onclick="openTab('imports',this)">Nhập</div>
    </div>
  </div>

  <!-- Modal bán -->
  <div class="modal fade" id="saleModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5>Bán sản phẩm</h5></div>
      <div class="modal-body">
        <p><b id="saleProductName"></b> (Tồn: <span id="saleStock"></span>)</p>
        <p>Giá bán: <span id="salePrice"></span></p>
        <input type="number" id="saleQty" class="form-control mb-2" placeholder="Số lượng">
        <p>Thành tiền: <span id="saleTotal">0</span></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button class="btn btn-success" onclick="warehouse.confirmSale()">Bán</button>
      </div>
    </div></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB06U8J2owwj03mOU2MdcGlMnNxA0NN3Ms",
      authDomain: "la-phon-phong-phat.firebaseapp.com",
      databaseURL: "https://la-phon-phong-phat-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "la-phon-phong-phat",
      storageBucket: "la-phon-phong-phat.firebasestorage.app",
      messagingSenderId: "643189174098",
      appId: "1:643189174098:web:ed119570c5cb2e36e8148b",
      measurementId: "G-BCK9B2Z2J6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let role = "seller";
    let currentUser = null;
    let editingId = null;
    let saleProduct = null;

    const categories = ["La phông ánh kim","La phông nhựa","La phông vĩnh tường","Khung xương trần thả","Khung xương thạch cao","Tấm thạch cao","Nano","Phụ kiện khác"];
    const categoryColors = { "La phông ánh kim":"#cce5ff","La phông nhựa":"#cce5ff","La phông vĩnh tường":"#cce5ff","Khung xương trần thả":"#ffeeba","Khung xương thạch cao":"#ffeeba","Tấm thạch cao":"#d4edda","Nano":"#d4edda","Phụ kiện khác":"#e2e3e5" };
    const catSelect = document.getElementById("productCategory");
    categories.forEach(c => { let o=document.createElement("option");o.value=c;o.textContent=c;catSelect.appendChild(o); });

   function openTab(id, el){
  document.querySelectorAll(".tab-content").forEach(t=>t.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  if(el) el.classList.add("active");
}
    openTab("overview");

    function showAlert(msg,type="success"){document.getElementById("alertContainer").innerHTML=`<div class="alert alert-${type}">${msg}</div>`; setTimeout(()=>document.getElementById("alertContainer").innerHTML="",3000);}

    async function login(){ let email=loginEmail.value,pass=loginPass.value; try{ await signInWithEmailAndPassword(auth,email,pass);}catch(e){showAlert(e.message,"danger");}}
    async function register(){ let email=loginEmail.value,pass=loginPass.value; try{ await createUserWithEmailAndPassword(auth,email,pass); }catch(e){showAlert(e.message,"danger");}}
    function logout(){signOut(auth);}

    onAuthStateChanged(auth,u=>{ if(u){ currentUser=u; role=u.email.includes("stock")?"stock":"seller"; loginScreen.style.display="none"; appContainer.style.display="block"; warehouse.listen(); } else { currentUser=null; appContainer.style.display="none"; loginScreen.style.display="flex"; }});

    class WarehouseManager{
      constructor(){ this.productsCol=collection(db,"products"); this.salesCol=collection(db,"sales"); this.importsCol=collection(db,"imports"); }
      listen(){
        onSnapshot(this.productsCol,snap=>{ this.renderProducts(snap.docs.map(d=>({id:d.id,...d.data()}))); this.updateStats(snap.docs.map(d=>d.data())); });
        onSnapshot(this.salesCol,snap=>{ this.renderSales(snap.docs.map(d=>({id:d.id,...d.data()}))); });
        onSnapshot(this.importsCol,snap=>{ this.renderImports(snap.docs.map(d=>({id:d.id,...d.data()}))); });
      }
      async saveProduct(e){ e.preventDefault(); let data={ name:productName.value, code:productCode.value, category:productCategory.value, importPrice:+productImportPrice.value, sellPrice:+productSellPrice.value, stock:+productStock.value, sold:0, desc:productDesc.value }; if(editingId){ await updateDoc(doc(db,"products",editingId),data); editingId=null; } else { await addDoc(this.productsCol,data); await addDoc(this.importsCol,{...data,quantity:data.stock,total:data.importPrice*data.stock,createdAt:Date.now(),user:currentUser.email}); } e.target.reset(); showAlert("Lưu thành công"); }
      async deleteProduct(id){ if(role!=="stock"){showAlert("Chỉ stock được xóa","danger");return;} await deleteDoc(doc(db,"products",id)); showAlert("Đã xóa sản phẩm"); }
      editProduct(p){ editingId=p.id; productName.value=p.name;productCode.value=p.code;productCategory.value=p.category;productImportPrice.value=p.importPrice;productSellPrice.value=p.sellPrice;productStock.value=p.stock;productDesc.value=p.desc; openTab("overview"); }
      sellProduct(p){ saleProduct=p; saleProductName.textContent=p.name; saleStock.textContent=p.stock; salePrice.textContent=p.sellPrice+"₫"; saleQty.value=""; saleTotal.textContent="0"; new bootstrap.Modal(document.getElementById("saleModal")).show(); }
      async confirmSale(){ let qty=+saleQty.value; if(qty<=0||qty>saleProduct.stock){showAlert("SL không hợp lệ","danger");return;} let total=qty*saleProduct.sellPrice; await updateDoc(doc(db,"products",saleProduct.id),{stock:saleProduct.stock-qty,sold:(saleProduct.sold||0)+qty}); await addDoc(this.salesCol,{productId:saleProduct.id,name:saleProduct.name,code:saleProduct.code,quantity:qty,price:saleProduct.sellPrice,total,createdAt:Date.now(),user:currentUser.email}); bootstrap.Modal.getInstance(document.getElementById("saleModal")).hide(); showAlert("Đã bán"); }
      async deleteHistory(col,id,item){ if(role==="stock"){await deleteDoc(doc(db,col,id));} else { let last=this.lastSellerSale; if(item.user===currentUser.email&&item.id===last){await deleteDoc(doc(db,col,id));} else {showAlert("Seller chỉ được xóa lần bán gần nhất","danger");}} }
      renderProducts(list){ let html=""; list.forEach(p=>{ html+=`<div class="product-card" style="background:${categoryColors[p.category]||'#fff'}"><h5>${p.name}</h5><span class="badge-cat">${p.category}</span><p>Mã:${p.code} | Tồn:${p.stock} | Bán:${p.sold||0}</p><p>Giá nhập:${p.importPrice}₫ | Giá bán:${p.sellPrice}₫</p><button class="btn btn-sm btn-success me-1" onclick='warehouse.sellProduct(${JSON.stringify(p)})'>Bán</button>${role==="stock"?`<button class="btn btn-sm btn-primary me-1" onclick='warehouse.editProduct(${JSON.stringify(p)})'>Cập nhật</button><button class="btn btn-sm btn-danger" onclick='warehouse.deleteProduct("${p.id}")'>Xóa</button>`:""}</div>`; }); document.getElementById("productList").innerHTML=html; }
      renderSales(list){ list.sort((a,b)=>b.createdAt-a.createdAt); if(list.length>0)this.lastSellerSale=list.find(i=>i.user===currentUser.email)?.id; let html=""; list.forEach(i=>{ html+=`<tr><td>${new Date(i.createdAt).toLocaleString()}</td><td>${i.name}</td><td>${i.quantity}</td><td>${i.total}₫</td><td><button class="btn btn-sm btn-danger" onclick='warehouse.deleteHistory("sales","${i.id}",${JSON.stringify(i)})'>Xóa</button></td></tr>`; }); document.getElementById("salesHistory").innerHTML=html; }
      renderImports(list){ list.sort((a,b)=>b.createdAt-a.createdAt); let html=""; list.forEach(i=>{ html+=`<tr><td>${new Date(i.createdAt).toLocaleString()}</td><td>${i.name}</td><td>${i.stock}</td><td>${i.total}₫</td><td><button class="btn btn-sm btn-danger" onclick='warehouse.deleteHistory("imports","${i.id}",${JSON.stringify(i)})'>Xóa</button></td></tr>`; }); document.getElementById("importHistory").innerHTML=html; }
      updateStats(list){ document.getElementById("totalProducts").textContent=list.length; document.getElementById("totalValue").textContent=list.reduce((a,b)=>a+b.importPrice*b.stock,0)+"₫"; document.getElementById("lowStock").textContent=list.filter(p=>p.stock<5).length; }
    }
    const warehouse=new WarehouseManager();

    saleQty.addEventListener("input",()=>{ saleTotal.textContent=(+saleQty.value||0)*saleProduct.sellPrice+"₫"; });
  </script>
</body>
</html>
