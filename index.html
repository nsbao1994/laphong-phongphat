<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω kho La Ph√¥ng - PHONG PH√ÅT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{font-family: Inter, system-ui, -apple-system, Arial, sans-serif;background:#f6f8fb;}
    .app-container{max-width:1100px;margin:auto;background:#fff;min-height:100vh;display:none;}
    header{background:#0d6efd;color:#fff;padding:12px 16px;position:sticky;top:0;z-index:10}
    header .title{font-weight:600;margin:0;font-size:1.15rem}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:12px;background:#f9fbff;border-bottom:1px solid #e9eef6}
    .stat-card{background:#fff;border:1px solid #e7ecf4;border-radius:10px;padding:10px;text-align:center}
    .stat-card h3{margin:0;font-size:1.2rem}
    .stat-card p{margin:2px 0 0;color:#6b7280;font-size:.9rem}
    .tab-content{padding:16px 16px 80px}
    /* Bottom tabs */
    .bottom-tabs{position:fixed;left:0;right:0;bottom:0;background:#ffffff;border-top:1px solid #e5e7eb;display:flex;z-index:20}
    .bottom-tabs button{flex:1;border:0;background:#fff;padding:10px 6px;font-weight:600;color:#6b7280}
    .bottom-tabs button.active{color:#0d6efd;border-top:2px solid #0d6efd;background:#f8fbff}
    /* Cards */
    .product-card{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .badge-low{background:#fee2e2;color:#b91c1c}
    /* Login screen */
    #loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:#eef2f7}
    .login-card{width:360px;max-width:92vw;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <h5 class="mb-3">üîê ƒêƒÉng nh·∫≠p</h5>
    <div class="mb-2">
      <label class="form-label">Email</label>
      <input id="loginEmail" type="email" class="form-control" placeholder="email@domain.com">
    </div>
    <div class="mb-3">
      <label class="form-label">M·∫≠t kh·∫©u</label>
      <input id="loginPass" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="login()">ƒêƒÉng nh·∫≠p</button>
      <button class="btn btn-outline-secondary" onclick="register()">ƒêƒÉng k√Ω</button>
    </div>
    <div id="loginMsg" class="text-danger mt-2 small"></div>
  </div>
</div>

<!-- APP -->
<div class="app-container" id="app">
  <header class="d-flex align-items-center justify-content-between">
    <h1 class="title">Qu·∫£n l√Ω kho La Ph√¥ng - PHONG PH√ÅT</h1>
    <div>
      <span id="roleBadge" class="badge bg-light text-dark me-2">role</span>
      <button class="btn btn-sm btn-outline-light" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <!-- STATS -->
  <section class="stats">
    <div class="stat-card">
      <h3 id="totalProducts">0</h3>
      <p>T·ªïng s·∫£n ph·∫©m</p>
    </div>
    <div class="stat-card">
      <h3 id="totalValue">0‚Ç´</h3>
      <p>T·ªïng gi√° tr·ªã</p>
    </div>
    <div class="stat-card">
      <h3 id="lowStock">0</h3>
      <p>H√†ng s·∫Øp h·∫øt</p>
    </div>
    <div class="stat-card">
      <h3 id="totalSales">0‚Ç´</h3>
      <p>T·ªïng ti·ªÅn b√°n</p>
    </div>
  </section>

  <!-- OVERVIEW / IMPORT FORM -->
  <main id="tab-overview" class="tab-content">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="m-0">‚ûï Nh·∫≠p h√†ng</h5>
      <small class="text-muted">Ch·ªâ <b>stock</b> m·ªõi th·∫•y v√† s·ª≠ d·ª•ng</small>
    </div>

    <form id="productForm" class="row g-3">
      <div class="col-md-6">
        <label class="form-label">T√™n s·∫£n ph·∫©m</label>
        <input id="productName" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">M√£ s·∫£n ph·∫©m</label>
        <input id="productCode" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Danh m·ª•c</label>
        <input id="productCategory" class="form-control" placeholder="V√≠ d·ª•: Ph·ª• ki·ªán, V·ªè m√°y..." />
      </div>

      <div class="col-md-3">
        <label class="form-label">Gi√° nh·∫≠p</label>
        <input id="productImportPrice" type="number" min="0" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Gi√° b√°n</label>
        <input id="productSellPrice" type="number" min="0" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">S·ªë l∆∞·ª£ng nh·∫≠p</label>
        <input id="productQtyAdd" type="number" min="0" class="form-control" value="0" required>
        <div class="form-text">Khi c·∫≠p nh·∫≠t, s·ªë n√†y s·∫Ω ƒë∆∞·ª£c c·ªông th√™m v√†o t·ªìn hi·ªán t·∫°i</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">T·ªìn hi·ªán t·∫°i</label>
        <input id="productCurrentStock" type="number" class="form-control" value="0" disabled>
      </div>

      <div class="col-12">
        <label class="form-label">M√¥ t·∫£</label>
        <textarea id="productDesc" class="form-control" rows="2" placeholder="Ghi ch√∫"></textarea>
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary" type="submit">L∆∞u s·∫£n ph·∫©m</button>
        <button class="btn btn-outline-secondary" type="button" onclick="resetForm()">L√†m m·ªõi</button>
      </div>
    </form>
  </main>

  <!-- PRODUCTS -->
  <section id="tab-products" class="tab-content" style="display:none">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="m-0">üì¶ Danh s√°ch s·∫£n ph·∫©m</h5>
      <div class="d-flex gap-2">
        <input id="searchBox" class="form-control form-control-sm" placeholder="T√¨m t√™n ho·∫∑c m√£">
        <button class="btn btn-sm btn-outline-primary" onclick="warehouse.renderProducts(document.getElementById('searchBox').value)">T√¨m</button>
      </div>
    </div>
    <div id="productGrid" class="row g-3"></div>
  </section>

  <!-- SALES HISTORY -->
  <section id="tab-sales" class="tab-content" style="display:none">
    <h5>üí∞ L·ªãch s·ª≠ b√°n</h5>
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Ng√†y</th><th>T√™n</th><th>M√£</th><th>SL</th><th>Gi√°</th><th>T·ªïng</th><th>Ghi ch√∫</th><th>X√≥a</th>
          </tr>
        </thead>
        <tbody id="salesHistory"></tbody>
      </table>
    </div>
  </section>

  <!-- IMPORTS HISTORY -->
  <section id="tab-imports" class="tab-content" style="display:none">
    <h5>üìú L·ªãch s·ª≠ nh·∫≠p</h5>
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Ng√†y</th><th>T√™n</th><th>M√£</th><th>SL</th><th>Gi√°</th><th>T·ªïng</th><th>Ghi ch√∫</th><th>X√≥a</th>
          </tr>
        </thead>
        <tbody id="importHistory"></tbody>
      </table>
    </div>
  </section>

  <!-- Bottom Tabs -->
  <nav class="bottom-tabs">
    <button class="active" onclick="openTab('overview')">T·ªïng quan</button>
    <button onclick="openTab('products')">S·∫£n ph·∫©m</button>
    <button onclick="openTab('sales')">B√°n</button>
    <button onclick="openTab('imports')">Nh·∫≠p</button>
  </nav>

  <!-- ALERTS -->
  <div id="alertContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index:1080"></div>
</div>

<!-- SALE MODAL -->
<div class="modal fade" id="saleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">üí∞ B√°n h√†ng</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><b>T√™n:</b> <span id="saleName"></span></div>
        <div class="mb-2"><b>M√£:</b> <span id="saleCode"></span></div>
        <div class="row g-2">
          <div class="col-4">
            <label class="form-label">T·ªìn</label>
            <input id="saleStock" class="form-control" disabled>
          </div>
          <div class="col-4">
            <label class="form-label">Gi√° b√°n</label>
            <input id="salePrice" class="form-control" disabled>
          </div>
          <div class="col-4">
            <label class="form-label">S·ªë l∆∞·ª£ng</label>
            <input id="saleQty" type="number" min="1" class="form-control" value="1">
          </div>
        </div>
        <div class="mt-2">
          <label class="form-label">Ghi ch√∫</label>
          <input id="saleNote" class="form-control" placeholder="V√≠ d·ª•: kh√°ch quen, gi·∫£m 5k...">
        </div>
        <div class="alert alert-secondary mt-3 mb-0">
          <b>Th√†nh ti·ªÅn:</b> <span id="saleTotal">0‚Ç´</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button class="btn btn-primary" onclick="warehouse.confirmSale()">X√°c nh·∫≠n b√°n</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase Modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, getDocs, query, where 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { 
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  /* === Firebase Config c·ªßa b·∫°n === */
  const firebaseConfig = {
    apiKey: "AIzaSyB06U8J2owwj03mOU2MdcGlMnNxA0NN3Ms",
    authDomain: "la-phon-phong-phat.firebaseapp.com",
    databaseURL: "https://la-phon-phong-phat-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "la-phon-phong-phat",
    storageBucket: "la-phon-phong-phat.firebasestorage.app",
    messagingSenderId: "643189174098",
    appId: "1:643189174098:web:ed119570c5cb2e36e8148b",
    measurementId: "G-BCK9B2Z2J6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ======= Auth UI actions
  window.login = async function(){
    const email = document.getElementById("loginEmail").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      document.getElementById("loginMsg").textContent = "‚ùå " + e.message;
    }
  }
  window.register = async function(){
    const email = document.getElementById("loginEmail").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await addDoc(collection(db,"users"),{ uid: cred.user.uid, email, role: "seller" });
      alert("‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! T√†i kho·∫£n m·ªõi l√† seller.");
    }catch(e){
      document.getElementById("loginMsg").textContent = "‚ùå " + e.message;
    }
  }
  window.logout = function(){ signOut(auth); }

  // ======= State
  let role = "seller";
  let currentUser = null;
  let saleModal, saleProductId = null;

  function currency(n){ return (n||0).toLocaleString('vi-VN') + '‚Ç´'; }

  function toast(msg, type='success'){
    const cont = document.getElementById('alertContainer');
    const el = document.createElement('div');
    el.className = `toast align-items-center text-bg-${type==='success'?'success':'danger'} border-0 show`;
    el.setAttribute('role','alert');
    el.innerHTML = `<div class="d-flex">
      <div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>`;
    cont.appendChild(el);
    setTimeout(()=> el.remove(), 3500);
  }

  window.openTab = function(name){
    document.querySelectorAll('.bottom-tabs button').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.bottom-tabs button[onclick="openTab('${name}')"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+name).style.display='block';
  }

  window.resetForm = function(){
    document.getElementById('productForm').reset();
    document.getElementById('productCurrentStock').value = 0;
    warehouse.editingId = null;
  }

  class Warehouse {
    constructor(){
      this.products = {};
      this.editingId = null;
      this.latestSaleIdOfUser = null; // ƒë·ªÉ ki·ªÉm tra seller x√≥a l·ªãch s·ª≠ g·∫ßn nh·∫•t
      this.init();
    }

    init(){
      // Products
      onSnapshot(collection(db,'products'), snap => {
        this.products = {};
        snap.forEach(d => this.products[d.id] = { id: d.id, ...d.data() });
        this.renderProducts();
        this.updateStats();
      });

      // Sales
      onSnapshot(collection(db,'sales'), snap => {
        const arr = [];
        snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
        // T√≠nh latest sale id c·ªßa user hi·ªán t·∫°i (ƒë·ªÉ seller x√≥a l·∫ßn b√°n g·∫ßn nh·∫•t c·ªßa ch√≠nh m√¨nh)
        if(currentUser){
          const mySales = arr.filter(x => x.uid === currentUser.uid)
                             .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
          this.latestSaleIdOfUser = mySales[0]?.id || null;
        }
        this.renderHistory(arr,'salesHistory','sales');
        const total = arr.reduce((a,b)=>a+(b.total||0),0);
        document.getElementById('totalSales').textContent = currency(total);
      });

      // Imports
      onSnapshot(collection(db,'imports'), snap => {
        const arr = [];
        snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
        this.renderHistory(arr,'importHistory','imports');
      });

      // Form submit
      document.getElementById('productForm').addEventListener('submit', (e)=> this.saveProduct(e));
    }

    renderProducts(search=''){
      const grid = document.getElementById('productGrid');
      let arr = Object.values(this.products);
      if(search){
        const s = search.trim().toLowerCase();
        arr = arr.filter(p => p.name?.toLowerCase().includes(s) || p.code?.toLowerCase().includes(s));
      }
      if(arr.length === 0){
        grid.innerHTML = `<div class="text-center text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m</div>`;
        return;
      }
      grid.innerHTML = arr.map(p=>`
        <div class="col-12 col-md-6">
          <div class="product-card d-flex flex-column gap-1">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-semibold">${p.name}</div>
                <div class="small text-muted">M√£: ${p.code} ‚Ä¢ Danh m·ª•c: ${p.category||'-'}</div>
              </div>
              ${(p.stock||0)<=10?`<span class="badge badge-low">S·∫Øp h·∫øt</span>`:''}
            </div>
            <div class="row small text-muted">
              <div class="col">Gi√° nh·∫≠p: <b>${currency(p.importPrice)}</b></div>
              <div class="col">Gi√° b√°n: <b>${currency(p.sellPrice)}</b></div>
            </div>
            <div class="row small text-muted">
              <div class="col">T·ªìn: <b>${p.stock||0}</b></div>
              <div class="col">ƒê√£ b√°n: <b>${p.sold||0}</b></div>
            </div>
            <div class="d-flex gap-2 mt-1">
              <button class="btn btn-sm btn-primary" onclick="warehouse.openSale('${p.id}')">B√°n</button>
              ${role==='stock'?`
                <button class="btn btn-sm btn-outline-secondary" onclick="warehouse.editProduct('${p.id}')">S·ª≠a</button>
                <button class="btn btn-sm btn-outline-danger" onclick="warehouse.deleteProduct('${p.id}')">X√≥a</button>`:''}
            </div>
          </div>
        </div>
      `).join('');
    }

    updateStats(){
      const arr = Object.values(this.products);
      const total = arr.length;
      const totalVal = arr.reduce((a,p)=>a + (p.importPrice||0)*(p.stock||0), 0);
      const low = arr.filter(p => (p.stock||0) <= 10).length;
      document.getElementById('totalProducts').textContent = total;
      document.getElementById('totalValue').textContent = currency(totalVal);
      document.getElementById('lowStock').textContent = low;
    }

    // ======= Import form (stock only)
    async saveProduct(e){
      e.preventDefault();
      if(role!=='stock'){ toast('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn nh·∫≠p/c·∫≠p nh·∫≠t','danger'); return; }

      const name = document.getElementById('productName').value.trim();
      const code = document.getElementById('productCode').value.trim();
      const category = document.getElementById('productCategory').value.trim();
      const importPrice = Number(document.getElementById('productImportPrice').value)||0;
      const sellPrice = Number(document.getElementById('productSellPrice').value)||0;
      const qtyAdd = Number(document.getElementById('productQtyAdd').value)||0;
      const desc = document.getElementById('productDesc').value.trim();
      const date = new Date().toISOString().split('T')[0];
      const nowIso = new Date().toISOString();

      if(this.editingId){
        // update
        const p = this.products[this.editingId];
        const newStock = (p.stock||0) + qtyAdd;
        await updateDoc(doc(db,'products',this.editingId), {
          name, code, category, importPrice, sellPrice,
          stock: newStock,
          description: desc,
          updatedAt: nowIso
        });
        if(qtyAdd>0){
          await addDoc(collection(db,'imports'), {
            uid: currentUser?.uid || null,
            name, code, qty: qtyAdd, price: importPrice,
            total: importPrice * qtyAdd, date,
            note: "C·∫≠p nh·∫≠t t·ªìn kho",
            createdAt: nowIso
          });
        }
        toast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·∫£n ph·∫©m');
        this.editingId = null;
      }else{
        // add new
        const ref = await addDoc(collection(db,'products'), {
          name, code, category, importPrice, sellPrice,
          stock: qtyAdd, sold: 0,
          description: desc,
          createdAt: nowIso, updatedAt: nowIso
        });
        if(qtyAdd>0){
          await addDoc(collection(db,'imports'), {
            uid: currentUser?.uid || null,
            name, code, qty: qtyAdd, price: importPrice,
            total: importPrice * qtyAdd, date,
            note: "Nh·∫≠p m·ªõi",
            createdAt: nowIso
          });
        }
        toast('‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m');
      }
      resetForm();
    }

    editProduct(id){
      if(role!=='stock'){ toast('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a','danger'); return; }
      const p = this.products[id];
      if(!p) return;
      this.editingId = id;
      document.getElementById('productName').value = p.name || '';
      document.getElementById('productCode').value = p.code || '';
      document.getElementById('productCategory').value = p.category || '';
      document.getElementById('productImportPrice').value = p.importPrice || 0;
      document.getElementById('productSellPrice').value = p.sellPrice || 0;
      document.getElementById('productQtyAdd').value = 0; // ch·ªâ nh·∫≠p th√™m
      document.getElementById('productCurrentStock').value = p.stock || 0;
      document.getElementById('productDesc').value = p.description || '';
      openTab('overview');
    }

    async deleteProduct(id){
      if(role!=='stock'){ toast('‚ùå Kh√¥ng c√≥ quy·ªÅn x√≥a','danger'); return; }
      const p = this.products[id];
      if(!p) return;
      if(!confirm('X√≥a s·∫£n ph·∫©m v√† to√†n b·ªô l·ªãch s·ª≠ li√™n quan?')) return;

      // X√≥a l·ªãch s·ª≠ li√™n quan theo code
      const code = p.code;
      const qi = query(collection(db,'imports'), where('code','==',code));
      const si = await getDocs(qi);
      for(const d of si.docs){ await deleteDoc(doc(db,'imports', d.id)); }

      const qs = query(collection(db,'sales'), where('code','==',code));
      const ss = await getDocs(qs);
      for(const d of ss.docs){ await deleteDoc(doc(db,'sales', d.id)); }

      await deleteDoc(doc(db,'products', id));
      toast('‚úÖ ƒê√£ x√≥a s·∫£n ph·∫©m + l·ªãch s·ª≠');
    }

    // ======= Sale flow
    openSale(id){
      const p = this.products[id]; if(!p) return;
      saleProductId = id;
      document.getElementById('saleName').textContent = p.name;
      document.getElementById('saleCode').textContent = p.code;
      document.getElementById('saleStock').value = p.stock || 0;
      document.getElementById('salePrice').value = currency(p.sellPrice ?? p.importPrice ?? 0);
      document.getElementById('saleQty').value = 1;
      document.getElementById('saleNote').value = '';
      this.updateSaleTotal();
      saleModal = new bootstrap.Modal(document.getElementById('saleModal'));
      saleModal.show();
    }

    updateSaleTotal(){
      const id = saleProductId;
      const p = this.products[id]; if(!p) return;
      const qty = Math.max(1, parseInt(document.getElementById('saleQty').value||'1'));
      const price = p.sellPrice ?? p.importPrice ?? 0;
      document.getElementById('saleQty').value = qty;
      document.getElementById('saleTotal').textContent = currency(price*qty);
    }

    async confirmSale(){
      const id = saleProductId;
      const p = this.products[id]; if(!p) return;
      const qty = Math.max(1, parseInt(document.getElementById('saleQty').value||'1'));
      if(qty > (p.stock||0)){ toast('‚ùå Kh√¥ng ƒë·ªß t·ªìn kho','danger'); return; }
      const note = document.getElementById('saleNote').value.trim();
      const price = p.sellPrice ?? p.importPrice ?? 0;
      const total = price * qty;
      const date = new Date().toISOString().split('T')[0];
      const nowIso = new Date().toISOString();

      await updateDoc(doc(db,'products', id), {
        stock: (p.stock||0) - qty,
        sold: (p.sold||0) + qty,
        updatedAt: nowIso
      });
      await addDoc(collection(db,'sales'), {
        uid: currentUser?.uid || null,
        name: p.name, code: p.code,
        qty, price, total, date,
        note: note || "B√°n h√†ng",
        createdAt: nowIso
      });
      toast('‚úÖ ƒê√£ ghi b√°n h√†ng');
      saleModal?.hide();
    }

    // ======= History render + delete with permissions
    renderHistory(arr, target, type){
      const tb = document.getElementById(target);
      arr.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      tb.innerHTML = arr.map((i,idx)=>`
        <tr>
          <td>${i.date||''}</td>
          <td>${i.name||''}</td>
          <td>${i.code||''}</td>
          <td>${i.qty||0}</td>
          <td>${currency(i.price||0)}</td>
          <td>${currency(i.total||0)}</td>
          <td>${i.note||''}</td>
          <td>${this.canDeleteHistory(type, i, idx, arr) ? 
                `<button class="btn btn-sm btn-outline-danger" onclick="warehouse.deleteHistory('${type}','${i.id}')">X√≥a</button>` : ''}</td>
        </tr>
      `).join('');
      // c·∫≠p nh·∫≠t realtime totalSales ƒë√£ l√†m ·ªü onSnapshot(sales)
      // imports kh√¥ng c·∫ßn total to√†n c·ª•c
    }

    canDeleteHistory(type, rec, idx, arr){
      if(role === 'stock') return true;
      if(role === 'seller' && type === 'sales'){
        // ch·ªâ x√≥a l·∫ßn b√°n g·∫ßn nh·∫•t c·ªßa ch√≠nh m√¨nh
        return rec.uid === currentUser?.uid && rec.id === this.latestSaleIdOfUser;
      }
      return false;
    }

    async deleteHistory(type, docId){
      const col = type === 'sales' ? 'sales' : 'imports';
      if(role!=='stock' && !(role==='seller' && type==='sales')){
        toast('‚ùå Kh√¥ng c√≥ quy·ªÅn x√≥a','danger'); return;
      }
      if(!confirm('X√≥a l·ªãch s·ª≠ n√†y?')) return;
      await deleteDoc(doc(db, col, docId));
      toast('‚úÖ ƒê√£ x√≥a l·ªãch s·ª≠');
    }
  }

  // Global instance
  window.warehouse = new Warehouse();

  // Recompute sale total on qty change
  document.getElementById('saleQty').addEventListener('input', ()=> warehouse.updateSaleTotal());

  // ======= Auth state
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      currentUser = user;
      // L·∫•y role
      let myRole = 'seller';
      const us = await getDocs(collection(db,'users'));
      us.forEach(d => { if(d.data().uid === user.uid) myRole = d.data().role; });
      role = myRole;

      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('roleBadge').textContent = role;

      // ·∫®n form nh·∫≠p n·∫øu l√† seller
      const overview = document.getElementById('tab-overview');
      overview.style.display = (role==='stock') ? 'block' : 'none';
      // N·∫øu l√† seller, chuy·ªÉn sang tab s·∫£n ph·∫©m ƒë·ªÉ b√°n cho nhanh
      if(role==='seller'){ openTab('products'); }
    }else{
      currentUser = null;
      role = 'seller';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
    }
  });
</script>

</body>
</html>
