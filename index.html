<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý kho La Phông - PHONG PHÁT</title>
  <style>
    body {font-family: Arial, sans-serif; margin:0; padding:0;}
    .container {display:none; flex-direction:column; height:100vh;}
    .tabs {display:flex; justify-content:space-around; position:fixed; bottom:0; left:0; right:0; background:#eee; padding:10px;}
    .tab {flex:1; text-align:center; cursor:pointer; padding:10px;}
    .tab.active {background:#ccc;}
    .tab-content {flex:1; overflow:auto; padding:20px;}
    table {width:100%; border-collapse:collapse; margin-top:10px;}
    th, td {border:1px solid #ddd; padding:8px; text-align:left;}
    .btn {padding:5px 10px; margin:2px; cursor:pointer; border:none; border-radius:4px;}
    .btn-danger {background:#f44336; color:#fff;}
    .btn-primary {background:#2196F3; color:#fff;}
    .alert {padding:10px; margin:5px; border-radius:5px;}
    .alert-success {background:#dff0d8; color:#3c763d;}
    .alert-error {background:#f2dede; color:#a94442;}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB06U8J2owwj03mOU2MdcGlMnNxA0NN3Ms",
      authDomain: "la-phon-phong-phat.firebaseapp.com",
      databaseURL: "https://la-phon-phong-phat-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "la-phon-phong-phat",
      storageBucket: "la-phon-phong-phat.firebasestorage.app",
      messagingSenderId: "643189174098",
      appId: "1:643189174098:web:ed119570c5cb2e36e8148b",
      measurementId: "G-BCK9B2Z2J6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let role = "seller";

    class WarehouseManager {
      constructor(){
        this.products={};
        this.editingId=null;
        this.init();
      }
      init(){
        // load products
        onSnapshot(collection(db,'products'),snap=>{
          this.products={};
          let rows='';
          snap.forEach(d=>{
            const p=d.data();p.id=d.id;this.products[d.id]=p;
            rows+=`<tr>
              <td>${p.name}</td><td>${p.code}</td><td>${p.category||''}</td>
              <td>${p.importPrice||0}</td><td>${p.sellPrice||0}</td>
              <td>${p.stock||0}</td><td>${p.sold||0}</td>
              <td>
                ${role==="stock"?`<button class='btn btn-primary' onclick='warehouse.editProduct("${d.id}")'>Sửa</button>
                <button class='btn btn-danger' onclick='warehouse.deleteProduct("${d.id}")'>Xóa</button>`:''}
                <button class='btn btn-primary' onclick='warehouse.openSaleModal("${d.id}")'>Bán</button>
              </td>
            </tr>`;
          });
          document.getElementById('productTable').innerHTML=rows;
          this.updateStats();
        });

        // load sales
        onSnapshot(collection(db,'sales'),snap=>{
          let arr=[];snap.forEach(d=>arr.push(d.data()));
          this.renderHistory(arr,'salesHistory','sales');
          const total=arr.reduce((a,b)=>a+(b.total||0),0);
          document.getElementById('totalSales').textContent=total.toLocaleString('vi-VN')+'₫';
        });

        // load imports
        onSnapshot(collection(db,'imports'),snap=>{
          let arr=[];snap.forEach(d=>arr.push(d.data()));
          this.renderHistory(arr,'importHistory','imports');
        });
      }
      renderHistory(arr,target,type){
        const tb=document.getElementById(target);
        arr.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
        tb.innerHTML=arr.map((i,idx)=>`
          <tr>
            <td>${i.date}</td><td>${i.name}</td><td>${i.code}</td><td>${i.qty}</td>
            <td>${i.price}</td><td>${i.total}</td><td>${i.note||''}</td>
            <td>${this.canDeleteHistory(type,idx,arr.length)?`<button class='btn btn-danger' onclick="warehouse.deleteHistory('${type}','${i.code}','${i.createdAt}')">Xóa</button>`:''}</td>
          </tr>`).join('');
      }
      canDeleteHistory(type,idx,total){
        if(role==="stock") return true;
        if(role==="seller" && type==="sales" && idx===0) return true;
        return false;
      }
      async deleteHistory(type,code,createdAt){
        if(!confirm("Xóa lịch sử?")) return;
        const col=type==="sales"?"sales":"imports";
        const snap=await getDocs(collection(db,col));
        snap.forEach(async d=>{
          let data=d.data();
          if(data.code===code && data.createdAt===createdAt){
            await deleteDoc(doc(db,col,d.id));
            this.showAlert("✅ Đã xóa lịch sử","success");
          }
        });
      }
      async saveProduct(e){
        e.preventDefault();
        if(role!=="stock"){this.showAlert("❌ Không có quyền nhập kho","error");return;}
        const name=document.getElementById('productName').value.trim();
        const code=document.getElementById('productCode').value.trim();
        const category=document.getElementById('productCategory').value.trim();
        const importPrice=Number(document.getElementById('productImportPrice').value)||0;
        const sellPrice=Number(document.getElementById('productSellPrice').value)||0;
        const stock=Number(document.getElementById('productStock').value)||0;
        const desc=document.getElementById('productDesc').value.trim();
        const date=new Date().toISOString().split('T')[0];
        if(this.editingId){
          await updateDoc(doc(db,'products',this.editingId),{name,code,category,importPrice,sellPrice,stock,description:desc,updatedAt:new Date().toISOString()});
          await addDoc(collection(db,'imports'),{name,code,qty:stock,price:importPrice,total:importPrice*stock,date,note:"Cập nhật",createdAt:new Date().toISOString()});
          this.showAlert("✅ Đã cập nhật","success");
          this.editingId=null;
        }else{
          await addDoc(collection(db,'products'),{name,code,category,importPrice,sellPrice,stock,sold:0,description:desc,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
          await addDoc(collection(db,'imports'),{name,code,qty:stock,price:importPrice,total:importPrice*stock,date,note:"Nhập mới",createdAt:new Date().toISOString()});
          this.showAlert("✅ Đã thêm sản phẩm","success");
        }
        document.getElementById('productForm').reset();
      }
      async openSaleModal(id){
        const qty=prompt("Nhập số lượng bán:");
        if(!qty)return;const p=this.products[id];const n=parseInt(qty);
        if(n>p.stock){this.showAlert("❌ Không đủ tồn","error");return;}
        const newStock=p.stock-n,newSold=(p.sold||0)+n,date=new Date().toISOString().split('T')[0];
        await updateDoc(doc(db,'products',id),{stock:newStock,sold:newSold});
        await addDoc(collection(db,'sales'),{name:p.name,code:p.code,qty:n,price:p.sellPrice??p.importPrice,total:(p.sellPrice??p.importPrice)*n,date,note:"Bán hàng",createdAt:new Date().toISOString()});
        this.showAlert("✅ Đã bán","success");
      }
      async deleteProduct(id){
        if(role!=="stock"){this.showAlert("❌ Không có quyền xóa","error");return;}
        if(!confirm("Xóa sản phẩm và lịch sử?")) return;
        const code=this.products[id].code;
        await deleteDoc(doc(db,'products',id));
        let snap=await getDocs(collection(db,'imports'));
        snap.forEach(async d=>{if(d.data().code===code) await deleteDoc(doc(db,'imports',d.id));});
        snap=await getDocs(collection(db,'sales'));
        snap.forEach(async d=>{if(d.data().code===code) await deleteDoc(doc(db,'sales',d.id));});
        this.showAlert("✅ Đã xóa sản phẩm và lịch sử","success");
      }
      updateStats(){
        const arr=Object.values(this.products);const total=arr.length;
        const totalVal=arr.reduce((a,p)=>a+(p.importPrice??0)*(p.stock||0),0);
        const low=arr.filter(p=>(p.stock||0)<=10).length;
        document.getElementById('totalProducts').textContent=total;
        document.getElementById('totalValue').textContent=totalVal.toLocaleString('vi-VN')+'₫';
        document.getElementById('lowStock').textContent=low;
      }
      editProduct(id){
        const p=this.products[id];if(!p)return;this.editingId=id;
        document.getElementById('productName').value=p.name;
        document.getElementById('productCode').value=p.code;
        document.getElementById('productCategory').value=p.category;
        document.getElementById('productImportPrice').value=p.importPrice??0;
        document.getElementById('productSellPrice').value=p.sellPrice??0;
        document.getElementById('productStock').value=p.stock??0;
        document.getElementById('productDesc').value=p.description||'';
        openTab('overview');
      }
      showAlert(msg,type){
        const c=document.getElementById('alertContainer');const div=document.createElement('div');
        div.className='alert '+(type==='success'?'alert-success':'alert-error');div.textContent=msg;
        c.appendChild(div);setTimeout(()=>div.remove(),3000);
      }
    }
    window.warehouse=new WarehouseManager();

    // Tabs
    window.openTab=function(tab){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      document.getElementById(tab).style.display='block';
      document.querySelector(`[onclick="openTab('${tab}')"]`).classList.add('active');
    }

    // Auth
    async function login(){
      const email=document.getElementById('loginEmail').value;
      const pass=document.getElementById('loginPass').value;
      try{await signInWithEmailAndPassword(auth,email,pass);}catch(err){alert(err.message);}
    }
    async function register(){
      const email=document.getElementById('loginEmail').value;
      const pass=document.getElementById('loginPass').value;
      const cred=await createUserWithEmailAndPassword(auth,email,pass);
      await addDoc(collection(db,"users"),{uid:cred.user.uid,email,role:"seller"});
      alert("Đăng ký thành công!");
    }
    onAuthStateChanged(auth,async(user)=>{
      if(user){
        let snap=await getDocs(collection(db,"users"));let r="seller";
        snap.forEach(d=>{if(d.data().uid===user.uid) r=d.data().role;});
        role=r;
        document.getElementById('loginScreen').style.display="none";
        document.querySelector('.container').style.display="flex";
        openTab('overview');
      }else{
        document.getElementById('loginScreen').style.display="flex";
        document.querySelector('.container').style.display="none";
      }
    });
    window.logout=function(){signOut(auth);}
  </script>
</head>
<body>
  <div id="loginScreen" style="display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0">
    <div style="background:#fff;padding:20px;border-radius:12px;width:320px;text-align:center">
      <h2>Đăng nhập</h2>
      <input id="loginEmail" type="email" placeholder="Email"><br>
      <input id="loginPass" type="password" placeholder="Mật khẩu"><br>
      <button onclick="login()">Đăng nhập</button>
      <button onclick="register()">Đăng ký</button>
    </div>
  </div>
  <div class="container">
    <button onclick="logout()" style="position:absolute;top:10px;right:10px;">Đăng xuất</button>
    <div id="alertContainer"></div>
    <div id="overview" class="tab-content">
      <h3>Tổng quan</h3>
      <p>Số sản phẩm: <span id="totalProducts"></span></p>
      <p>Tổng giá trị: <span id="totalValue"></span></p>
      <p>Sắp hết hàng: <span id="lowStock"></span></p>
      <p>Tổng tiền bán: <span id="totalSales"></span></p>
      <form id="productForm" onsubmit="warehouse.saveProduct(event)">
        <input id="productName" placeholder="Tên"><br>
        <input id="productCode" placeholder="Mã"><br>
        <input id="productCategory" placeholder="Loại"><br>
        <input id="productImportPrice" type="number" placeholder="Giá nhập"><br>
        <input id="productSellPrice" type="number" placeholder="Giá bán"><br>
        <input id="productStock" type="number" placeholder="Số lượng"><br>
        <textarea id="productDesc" placeholder="Mô tả"></textarea><br>
        <button type="submit">Lưu</button>
      </form>
    </div>
    <div id="products" class="tab-content" style="display:none">
      <h3>Danh sách sản phẩm</h3>
      <table><thead><tr><th>Tên</th><th>Mã</th><th>Loại</th><th>Giá nhập</th><th>Giá bán</th><th>Tồn kho</th><th>Đã bán</th><th>Hành động</th></tr></thead><tbody id="productTable"></tbody></table>
    </div>
    <div id="sales" class="tab-content" style="display:none">
      <h3>Lịch sử bán</h3>
      <table><thead><tr><th>Ngày</th><th>Tên</th><th>Mã</th><th>SL</th><th>Giá</th><th>Tổng</th><th>Ghi chú</th><th>Xóa</th></tr></thead><tbody id="salesHistory"></tbody></table>
    </div>
    <div id="imports" class="tab-content" style="display:none">
      <h3>Lịch sử nhập</h3>
      <table><thead><tr><th>Ngày</th><th>Tên</th><th>Mã</th><th>SL</th><th>Giá</th><th>Tổng</th><th>Ghi chú</th><th>Xóa</th></tr></thead><tbody id="importHistory"></tbody></table>
    </div>
    <div class="tabs">
      <div class="tab" onclick="openTab('overview')">Tổng quan</div>
      <div class="tab" onclick="openTab('products')">Sản phẩm</div>
      <div class="tab" onclick="openTab('sales')">Bán</div>
      <div class="tab" onclick="openTab('imports')">Nhập</div>
    </div>
  </div>
</body>
</html>
