<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quáº£n lÃ½ kho La PhÃ´ng - PHONG PHÃT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body{font-family:Roboto,Arial,Helvetica,sans-serif;background:#f4f6f9;min-height:100vh;margin:0}
    .container{max-width:1200px;margin:auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1);display:flex;flex-direction:column;min-height:100vh;display:none}
    header{padding:12px 16px;background:#2196F3;color:#fff;position:relative}
    header h1{margin:0;font-size:1.4rem}
    .stats{display:flex;justify-content:space-around;padding:10px;background:#f9f9f9}
    .stat-item{text-align:center}
    .tab-bar{display:flex;background:#eee;border-top:1px solid #ccc;position:fixed;bottom:0;left:0;right:0}
    .tab-bar button{flex:1;padding:12px;cursor:pointer;background:#eee;border:none;font-weight:bold}
    .tab-bar button.active{background:#fff;border-top:2px solid #2196F3;color:#2196F3}
    .tab-content{flex:1;display:none;padding:14px;overflow-y:auto;margin-bottom:60px}
    .tab-content.active{display:block}
    .product-card{border:1px solid #ddd;padding:10px;margin:10px;border-radius:8px}
    .product-actions{margin-top:8px;display:flex;gap:6px}
    .btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
    .btn-primary{background:#2196F3;color:#fff}
    .btn-warning{background:#FF9800;color:#fff}
    .btn-danger{background:#f44336;color:#fff}
    .low{color:red;font-weight:bold}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:6px;text-align:center}
    .alert{padding:10px;margin:10px 0;border-radius:6px}
    .alert-success{background:#d4edda;color:#155724}
    .alert-error{background:#f8d7da;color:#721c24}
  </style>
</head>
<body>
<!-- Form Ä‘Äƒng nháº­p -->
<div id="loginScreen" style="display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0">
  <div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.2);width:320px;text-align:center">
    <h2>ğŸ”‘ ÄÄƒng nháº­p</h2>
    <input id="loginEmail" type="email" placeholder="Email" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc;border-radius:8px">
    <input id="loginPass" type="password" placeholder="Máº­t kháº©u" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ccc;border-radius:8px">
    <button onclick="login()" style="padding:10px 15px;width:100%;border:none;border-radius:8px;background:#2196F3;color:#fff;font-size:1rem;cursor:pointer">ÄÄƒng nháº­p</button>
    <button onclick="register()" style="margin-top:8px;padding:10px 15px;width:100%;border:none;border-radius:8px;background:#4CAF50;color:#fff;font-size:1rem;cursor:pointer">ÄÄƒng kÃ½</button>
    <div id="loginMsg" style="margin-top:10px;color:red"></div>
  </div>
</div>

<div class="container">
  <header>
    <h1>ğŸ“¦ Quáº£n lÃ½ kho La PhÃ´ng - PHONG PHÃT</h1>
    <button onclick="logout()" style="position:absolute;top:10px;right:10px;padding:5px 10px;background:#f44336;color:#fff;border:none;border-radius:6px;cursor:pointer">ÄÄƒng xuáº¥t</button>
  </header>
  <div class="stats">
    <div class="stat-item"><h3 id="totalProducts">0</h3><p>Tá»•ng SP</p></div>
    <div class="stat-item"><h3 id="totalValue">0â‚«</h3><p>Tá»•ng giÃ¡ trá»‹</p></div>
    <div class="stat-item"><h3 id="lowStock">0</h3><p>Sáº¯p háº¿t</p></div>
    <div class="stat-item"><h3 id="totalSales">0â‚«</h3><p>Tá»•ng bÃ¡n</p></div>
  </div>

  <!-- Tabs -->
  <div id="overview" class="tab-content active">
    <h2>â• Nháº­p hÃ ng</h2>
    <form id="productForm">
      <input id="productName" placeholder="TÃªn sáº£n pháº©m" required><br>
      <input id="productCode" placeholder="MÃ£ sáº£n pháº©m" required><br>
      <input id="productCategory" placeholder="Danh má»¥c"><br>
      <input id="productImportPrice" type="number" placeholder="GiÃ¡ nháº­p" required><br>
      <input id="productSellPrice" type="number" placeholder="GiÃ¡ bÃ¡n" required><br>
      <input id="productStock" type="number" placeholder="Sá»‘ lÆ°á»£ng nháº­p" required><br>
      <textarea id="productDesc" placeholder="MÃ´ táº£"></textarea><br>
      <button class="btn btn-primary" type="submit">LÆ°u sáº£n pháº©m</button>
    </form>
  </div>

  <div id="products" class="tab-content">
    <h2>ğŸ“¦ Danh sÃ¡ch sáº£n pháº©m</h2>
    <input id="searchBox" placeholder="TÃ¬m theo tÃªn hoáº·c mÃ£">
    <button onclick="warehouse.renderProducts(document.getElementById('searchBox').value)">TÃ¬m</button>
    <div id="productGrid"></div>
  </div>

  <div id="sales" class="tab-content">
    <h2>ğŸ’° Lá»‹ch sá»­ bÃ¡n</h2>
    <table>
      <thead><tr><th>NgÃ y</th><th>TÃªn</th><th>MÃ£</th><th>SL</th><th>GiÃ¡</th><th>Tá»•ng</th><th>Ghi chÃº</th><th>XÃ³a</th></tr></thead>
      <tbody id="salesHistory"></tbody>
    </table>
  </div>

  <div id="imports" class="tab-content">
    <h2>ğŸ“œ Lá»‹ch sá»­ nháº­p</h2>
    <table>
      <thead><tr><th>NgÃ y</th><th>TÃªn</th><th>MÃ£</th><th>SL</th><th>GiÃ¡</th><th>Tá»•ng</th><th>Ghi chÃº</th><th>XÃ³a</th></tr></thead>
      <tbody id="importHistory"></tbody>
    </table>
  </div>

  <div class="tab-bar">
    <button class="active" onclick="openTab('overview')">ğŸ“Š Nháº­p hÃ ng</button>
    <button onclick="openTab('products')">ğŸ“¦ Sáº£n pháº©m</button>
    <button onclick="openTab('sales')">ğŸ’° BÃ¡n</button>
    <button onclick="openTab('imports')">ğŸ“œ Nháº­p</button>
  </div>
  <div id="alertContainer"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, getDocs } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB06U8J2owwj03mOU2MdcGlMnNxA0NN3Ms",
    authDomain: "la-phon-phong-phat.firebaseapp.com",
    databaseURL: "https://la-phon-phong-phat-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "la-phon-phong-phat",
    storageBucket: "la-phon-phong-phat.firebasestorage.app",
    messagingSenderId: "643189174098",
    appId: "1:643189174098:web:ed119570c5cb2e36e8148b",
    measurementId: "G-BCK9B2Z2J6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let role = "seller"; 

  window.login = async function(){
    const email=document.getElementById("loginEmail").value;
    const pass=document.getElementById("loginPass").value;
    try{await signInWithEmailAndPassword(auth,email,pass);}
    catch(err){document.getElementById("loginMsg").textContent="âŒ "+err.message;}
  }
  window.register = async function(){
    const email=document.getElementById("loginEmail").value;
    const pass=document.getElementById("loginPass").value;
    try{
      const userCred=await createUserWithEmailAndPassword(auth,email,pass);
      await addDoc(collection(db,"users"),{uid:userCred.user.uid,email,role:"seller"});
      alert("âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! Báº¡n lÃ  ngÆ°á»i bÃ¡n.");
    }catch(err){document.getElementById("loginMsg").textContent="âŒ "+err.message;}
  }
  window.logout=function(){signOut(auth)}

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      const snap=await getDocs(collection(db,"users"));
      let myRole="seller";
      snap.forEach(d=>{if(d.data().uid===user.uid) myRole=d.data().role;});
      role=myRole;
      document.getElementById("loginScreen").style.display="none";
      document.querySelector(".container").style.display="flex";
      setRole(role);
    }else{
      document.getElementById("loginScreen").style.display="flex";
      document.querySelector(".container").style.display="none";
    }
  });

  window.openTab=function(id){
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-bar button').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.tab-bar button[onclick="openTab('${id}')"]`).classList.add('active');
  }
  window.setRole=function(r){
    role=r;
    if(role==="seller"){
      document.getElementById('overview').style.display="none";
      document.querySelector(`.tab-bar button[onclick="openTab('overview')"]`).style.display="none";
    }else{
      document.getElementById('overview').style.display="block";
      document.querySelector(`.tab-bar button[onclick="openTab('overview')"]`).style.display="inline-block";
    }
    warehouse.renderProducts();
  }

  class WarehouseManager {
    constructor(){this.products={};this.editingId=null;this.init();}
    async init(){
      onSnapshot(collection(db,'products'),snap=>{
        this.products={};snap.forEach(d=>this.products[d.id]={id:d.id,...d.data()});
        this.renderProducts();this.updateStats();
      });
      onSnapshot(collection(db,'sales'),snap=>{
        let arr=[];snap.forEach(d=>arr.push(d.data()));
        this.renderHistory(arr,'salesHistory','sales');
        const total=arr.reduce((a,b)=>a+(b.total||0),0);
        document.getElementById('totalSales').textContent=total.toLocaleString('vi-VN')+'â‚«';
      });
      onSnapshot(collection(db,'imports'),snap=>{
        let arr=[];snap.forEach(d=>arr.push(d.data()));
        this.renderHistory(arr,'importHistory','imports');
      });
      document.getElementById('productForm').addEventListener('submit',e=>this.saveProduct(e));
    }
   async saveProduct(e){
  e.preventDefault();
  if(role==="seller"){
    this.showAlert('âŒ Báº¡n khÃ´ng cÃ³ quyá»n nháº­p kho','error');
    return;
  }
  const name=document.getElementById('productName').value.trim();
  const code=document.getElementById('productCode').value.trim();
  const category=document.getElementById('productCategory').value.trim();
  const importPrice=Number(document.getElementById('productImportPrice').value)||0;
  const sellPrice=Number(document.getElementById('productSellPrice').value)||0;
  const addStock=Number(document.getElementById('productStock').value)||0;
  const desc=document.getElementById('productDesc').value.trim();
  const date=new Date().toISOString().split('T')[0];

  if(this.editingId){
    const p=this.products[this.editingId];
    const newStock=addStock; // âœ… dÃ¹ng giÃ¡ trá»‹ nháº­p trong form (cÃ³ thá»ƒ lÃ  sá»­a trá»±c tiáº¿p tá»“n kho)
    await updateDoc(doc(db,'products',this.editingId),{
      name,code,category,importPrice,sellPrice,stock:newStock,
      description:desc,updatedAt:new Date().toISOString()
    });
    this.showAlert('âœ… ÄÃ£ cáº­p nháº­t','success');
    this.editingId=null;
  } else {
    await addDoc(collection(db,'products'),{
      name,code,category,importPrice,sellPrice,stock:addStock,sold:0,
      description:desc,createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString()
    });
    this.showAlert('âœ… ÄÃ£ thÃªm sáº£n pháº©m','success');
  }
  document.getElementById('productForm').reset();
}


    async deleteHistory(type,code,createdAt){
      if(!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a lá»‹ch sá»­ nÃ y?")) return;
      const col=type==="sales"?"sales":"imports";
      const snap=await getDocs(collection(db,col));
      snap.forEach(async d=>{
        let data=d.data();
        if(data.code===code && data.createdAt===createdAt){
          if(role==="stock" || (role==="seller" && type==="sales")){await deleteDoc(doc(db,col,d.id));this.showAlert("âœ… ÄÃ£ xÃ³a lá»‹ch sá»­","success");}
        }
      });
    }
    canDeleteHistory(type,idx,arr){
      if(role==="stock") return true;
      if(role==="seller" && type==="sales" && idx===0) return true;
      return false;
    }
    renderHistory(arr,target,type){
      const tb=document.getElementById(target);arr.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
      tb.innerHTML=arr.map((i,idx)=>`<tr>
        <td>${i.date}</td><td>${i.name}</td><td>${i.code}</td><td>${i.qty}</td>
        <td>${i.price.toLocaleString('vi-VN')}â‚«</td><td>${i.total.toLocaleString('vi-VN')}â‚«</td><td>${i.note||''}</td>
        <td>${this.canDeleteHistory(type,idx,arr)?`<button class="btn btn-danger" onclick="warehouse.deleteHistory('${type}','${i.code}','${i.createdAt}')">XÃ³a</button>`:""}</td>
      </tr>`).join('');
    }
    renderProducts(search=''){
      const grid=document.getElementById('productGrid');let arr=Object.values(this.products);
      if(search){arr=arr.filter(p=>p.name.toLowerCase()===search.toLowerCase()||p.code.toLowerCase()===search.toLowerCase());}
      if(arr.length===0){grid.innerHTML='<p style="text-align:center;color:#666">KhÃ´ng cÃ³ sáº£n pháº©m</p>';return;}
      grid.innerHTML=arr.map(p=>`<div class="product-card">
        <h3>${p.name}</h3>
        <div><b>MÃ£:</b> ${p.code}</div>
        <div><b>GiÃ¡ nháº­p:</b> ${(p.importPrice??0).toLocaleString('vi-VN')}â‚«</div>
        <div><b>GiÃ¡ bÃ¡n:</b> ${(p.sellPrice??0).toLocaleString('vi-VN')}â‚«</div>
        <div><b>Tá»“n:</b> ${p.stock} ${(p.stock||0)<=10?'<span class="low">ğŸ”´</span>':''}</div>
        <div><b>ÄÃ£ bÃ¡n:</b> ${p.sold||0}</div>
        <div class="product-actions">
          <button class="btn btn-primary" onclick="warehouse.openSaleModal('${p.id}')">ğŸ’° BÃ¡n</button>
          ${role==="stock"?`<button class="btn btn-warning" onclick="warehouse.editProduct('${p.id}')">âœï¸ Cáº­p nháº­t</button>
          <button class="btn btn-danger" onclick="warehouse.deleteProduct('${p.id}')">ğŸ—‘ï¸ XÃ³a</button>`:""}
        </div>
      </div>`).join('');
    }
    async openSaleModal(id){
      const qty=prompt("Nháº­p sá»‘ lÆ°á»£ng bÃ¡n:");
      if(!qty)return;const p=this.products[id];const n=parseInt(qty);
      if(n>p.stock){this.showAlert("âŒ KhÃ´ng Ä‘á»§ tá»“n kho","error");return;}
      const newStock=p.stock-n,newSold=(p.sold||0)+n,date=new Date().toISOString().split('T')[0];
      await updateDoc(doc(db,'products',id),{stock:newStock,sold:newSold});
      await addDoc(collection(db,'sales'),{name:p.name,code:p.code,qty:n,price:p.sellPrice??p.importPrice,total:(p.sellPrice??p.importPrice)*n,date,note:"BÃ¡n hÃ ng",createdAt:new Date().toISOString()});
      this.showAlert("âœ… ÄÃ£ bÃ¡n","success");
    }
    async deleteProduct(id){
      if(role!=="stock"){this.showAlert("âŒ KhÃ´ng cÃ³ quyá»n xÃ³a","error");return;}
      if(!confirm("XÃ³a sáº£n pháº©m + lá»‹ch sá»­?")) return;
      await deleteDoc(doc(db,'products',id));
      let snap=await getDocs(collection(db,'imports'));snap.forEach(async d=>{if(d.data().code===this.products[id].code) await deleteDoc(doc(db,'imports',d.id));});
      snap=await getDocs(collection(db,'sales'));snap.forEach(async d=>{if(d.data().code===this.products[id].code) await deleteDoc(doc(db,'sales',d.id));});
      this.showAlert("âœ… ÄÃ£ xÃ³a sáº£n pháº©m vÃ  lá»‹ch sá»­","success");
    }
    updateStats(){
      const arr=Object.values(this.products);const total=arr.length;
      const totalVal=arr.reduce((a,p)=>a+(p.importPrice??0)*(p.stock||0),0);
      const low=arr.filter(p=>(p.stock||0)<=10).length;
      document.getElementById('totalProducts').textContent=total;
      document.getElementById('totalValue').textContent=totalVal.toLocaleString('vi-VN')+'â‚«';
      document.getElementById('lowStock').textContent=low;
    }
   editProduct(id){
  if(role==="seller"){
    this.showAlert('âŒ Báº¡n khÃ´ng cÃ³ quyá»n sá»­a','error');
    return;
  }
  const p = this.products[id];
  if(!p) return;
  this.editingId = id;

  document.getElementById('productName').value = p.name;
  document.getElementById('productCode').value = p.code;
  document.getElementById('productCategory').value = p.category;
  document.getElementById('productImportPrice').value = p.importPrice ?? 0;
  document.getElementById('productSellPrice').value = p.sellPrice ?? 0;
  
  // âœ… giá»¯ nguyÃªn sá»‘ lÆ°á»£ng tá»“n kho Ä‘á»ƒ dá»… theo dÃµi
  document.getElementById('productStock').value = p.stock ?? 0; 
  
  document.getElementById('productDesc').value = p.description || '';
  openTab('overview');
}

    showAlert(msg,type){
      const c=document.getElementById('alertContainer');const div=document.createElement('div');
      div.className='alert '+(type==='success'?'alert-success':'alert-error');div.textContent=msg;
      c.appendChild(div);setTimeout(()=>div.remove(),3000);
    }
  }
  window.warehouse=new WarehouseManager();
</script>
</body>
</html>
